<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FRC Blockly Visual IDE</title>
  <!-- Blockly Core -->
  <script src="https://unpkg.com/blockly@8.0.0/blockly.min.js"></script>
  <script src="https://unpkg.com/blockly@8.0.0/blocks_compressed.js"></script>
  <script src="https://unpkg.com/blockly@8.0.0/javascript_compressed.js"></script>
  <script src="https://unpkg.com/blockly@8.0.0/core/xml.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #tabs {
      display: flex;
      border-bottom: 1px solid #ccc;
      background: #f5f5f5;
      overflow-x: auto;
    }
    #tabs button {
      padding: 8px 12px;
      border: none;
      background: none;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      font-weight: 600;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    #tabs button.active {
      border-bottom-color: #0066cc;
      background: #fff;
      font-weight: 700;
    }
    #tabs button .close-btn {
      font-weight: 700;
      color: #999;
      cursor: pointer;
    }
    #tabs button .close-btn:hover { color: #c00; }
    #workspaceContainer {
      flex: 1;
      position: relative;
      min-height: 500px;
    }
    .blocklyDiv {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }
    .blocklyMainBackground {
      stroke: none;
    }
    #controls {
      padding: 8px;
      background: #eee;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    #output {
      flex: 1 1 100%;
      background: #111;
      color: #0f0;
      padding: 12px;
      font-family: monospace;
      white-space: pre-wrap;
      overflow-y: auto;
      max-height: 200px;
      border-top: 1px solid #ccc;
    }
  </style>
</head>
<body>

<div id="tabs"></div>
<div id="workspaceContainer"></div>

<div id="controls">
  <select id="tabTypeSelector">
    <option value="command">Command</option>
    <option value="subsystem">Subsystem</option>
    <option value="robotJava">Robot.java</option>
  </select>
  <button id="addTabBtn">Add Tab</button>
  <button id="generateJava">Generate Java</button>
  <button id="openCredits">Credits</button>
</div>

<pre id="output">// Your generated Java code will appear here</pre>

<xml id="toolbox" style="display:none">
  <category name="Logic" colour="#5C81A6">
    <block type="controls_if"></block>
    <block type="logic_compare"></block>
  </category>
  <category name="Loops" colour="#5CA65C">
    <block type="controls_repeat_ext"></block>
  </category>
  <category name="Math" colour="#5C68A6">
    <block type="math_number"></block>
    <block type="math_arithmetic"></block>
  </category>
  <category name="Text" colour="#5CA68D">
    <block type="text"></block>
    <block type="text_print"></block>
  </category>
  <category name="Custom FRC" colour="#A65C81">
    <block type="set_motor_speed"></block>
  </category>
</xml>

<script>
// Define custom blocks
Blockly.defineBlocksWithJsonArray([
  {
    "type": "set_motor_speed",
    "message0": "set motor %1 speed to %2",
    "args0": [
      {
        "type": "field_dropdown",
        "name": "MOTOR",
        "options": [
          ["left", "LEFT"],
          ["right", "RIGHT"]
        ]
      },
      {
        "type": "input_value",
        "name": "SPEED",
        "check": "Number"
      }
    ],
    "previousStatement": null,
    "nextStatement": null,
    "colour": 230,
    "tooltip": "Set the speed of the selected motor.",
    "helpUrl": ""
  }
]);

// Tab presets with proper XML formatting
const tabPresets = {
  robot: `<xml xmlns="https://developers.google.com/blockly/xml">
    <block type="text_print" x="50" y="50">
      <value name="TEXT">
        <shadow type="text">
          <field name="TEXT">Hello Robot</field>
        </shadow>
      </value>
    </block>
  </xml>`,
  robotContainer: `<xml xmlns="https://developers.google.com/blockly/xml">
    <block type="controls_if" x="50" y="50"></block>
  </xml>`,
  credits: `<xml xmlns="https://developers.google.com/blockly/xml">
    <block type="text_print" x="50" y="50">
      <value name="TEXT">
        <shadow type="text">
          <field name="TEXT">FRC Blockly IDE</field>
        </shadow>
      </value>
    </block>
  </xml>`,
  command: `<xml xmlns="https://developers.google.com/blockly/xml">
    <block type="controls_repeat_ext" x="50" y="50"></block>
  </xml>`,
  subsystem: `<xml xmlns="https://developers.google.com/blockly/xml">
    <block type="math_number" x="50" y="50">
      <field name="NUM">123</field>
    </block>
  </xml>`,
  robotJava: `<xml xmlns="https://developers.google.com/blockly/xml"></xml>`
};

// Main application
const workspaceContainer = document.getElementById('workspaceContainer');
const tabsContainer = document.getElementById('tabs');
const tabTypeSelector = document.getElementById('tabTypeSelector');
const addTabBtn = document.getElementById('addTabBtn');
const generateJavaBtn = document.getElementById('generateJava');
const openCreditsBtn = document.getElementById('openCredits');
const outputArea = document.getElementById('output');

const workspaces = {};
const tabs = [];
let activeTabId = null;
let tabCounter = 0;

const coreTabs = [
  { id: 'robot', title: 'Robot', type: 'robot', removable: false },
  { id: 'robotContainer', title: 'Robot Container', type: 'robotContainer', removable: false },
  { id: 'credits', title: 'Credits', type: 'credits', removable: false }
];

function createTabElement(tab) {
  const btn = document.createElement('button');
  btn.textContent = tab.title;
  btn.id = 'tabBtn_' + tab.id;
  btn.dataset.tabId = tab.id;
  if (tab.removable) {
    const closeBtn = document.createElement('span');
    closeBtn.textContent = 'Ã—';
    closeBtn.className = 'close-btn';
    closeBtn.addEventListener('click', e => {
      e.stopPropagation();
      removeTab(tab.id);
    });
    btn.appendChild(closeBtn);
  }
  btn.addEventListener('click', () => switchTab(tab.id));
  return btn;
}

function createWorkspace(tab) {
  let div = document.getElementById(tab.id);
  if (!div) {
    div = document.createElement('div');
    div.id = tab.id;
    div.className = 'blocklyDiv';
    workspaceContainer.appendChild(div);
  }

  // Initialize Blockly workspace with proper configuration
  workspaces[tab.id] = Blockly.inject(div, {
    toolbox: document.getElementById('toolbox'),
    trashcan: true,
    scrollbars: true,
    sounds: false,
    move: {
      scrollbars: true,
      drag: true,
      wheel: true
    },
    zoom: {
      controls: true,
      wheel: true,
      startScale: 1.0,
      maxScale: 3,
      minScale: 0.3
    },
    renderer: 'thrasos',
    theme: Blockly.Themes.Classic
  });

  // Load preset if available
  const presetXml = tabPresets[tab.type];
  if (presetXml) {
    try {
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(presetXml, 'text/xml');
      Blockly.Xml.domToWorkspace(xmlDoc.documentElement, workspaces[tab.id]);
    } catch (e) {
      console.error(`Error loading XML for tab ${tab.id}`, e);
    }
  }

  // Force resize after initialization
  setTimeout(() => {
    if (workspaces[tab.id]) {
      workspaces[tab.id].render();
      Blockly.svgResize(workspaces[tab.id]);
    }
  }, 100);

  div.style.display = 'none';
}

function renderTabs() {
  tabsContainer.innerHTML = '';
  tabs.forEach(tab => {
    const btn = createTabElement(tab);
    tabsContainer.appendChild(btn);
  });
}

function switchTab(tabId) {
  activeTabId = tabId;

  tabs.forEach(tab => {
    const div = document.getElementById(tab.id);
    const btn = document.getElementById(`tabBtn_${tab.id}`);
    const isActive = tab.id === tabId;

    if (div) div.style.display = isActive ? 'block' : 'none';
    if (btn) btn.classList.toggle('active', isActive);

    if (isActive && workspaces[tab.id]) {
      setTimeout(() => {
        workspaces[tab.id].render();
        Blockly.svgResize(workspaces[tab.id]);
      }, 10);
    }
  });

  outputArea.textContent = '';
}

function addTab() {
  const type = tabTypeSelector.value;
  tabCounter++;
  const id = type + '_' + tabCounter;
  const title = type.charAt(0).toUpperCase() + type.slice(1) + ' ' + tabCounter;
  const tab = { id, title, type, removable: true };
  tabs.push(tab);
  renderTabs();
  createWorkspace(tab);
  switchTab(id);
}

function removeTab(tabId) {
  if (coreTabs.find(t => t.id === tabId)) {
    alert("Core tabs cannot be removed.");
    return;
  }
  const tabIndex = tabs.findIndex(t => t.id === tabId);
  if (tabIndex === -1) return;

  if (workspaces[tabId]) {
    workspaces[tabId].dispose();
    delete workspaces[tabId];
  }
  const div = document.getElementById(tabId);
  if (div) div.remove();
  tabs.splice(tabIndex, 1);

  if (activeTabId === tabId) {
    switchTab(coreTabs[0].id);
  }
  renderTabs();
}

function generateJava() {
  if (!activeTabId) return;
  const ws = workspaces[activeTabId];
  if (!ws) return;
  try {
    const code = Blockly.JavaScript.workspaceToCode(ws);
    outputArea.textContent = code || '// No code generated';
  } catch (e) {
    outputArea.textContent = '// Error generating code:\n' + e;
  }
}

function init() {
  coreTabs.forEach(tab => tabs.push(tab));
  renderTabs();
  tabs.forEach(tab => createWorkspace(tab));
  switchTab(coreTabs[0].id);
}

// Event listeners
addTabBtn.addEventListener('click', addTab);
generateJavaBtn.addEventListener('click', generateJava);
openCreditsBtn.addEventListener('click', () => switchTab('credits'));

// Initialize when Blockly is ready
document.addEventListener('DOMContentLoaded', init);

// Handle window resize
window.addEventListener('resize', () => {
  if (activeTabId && workspaces[activeTabId]) {
    Blockly.svgResize(workspaces[activeTabId]);
  }
});
</script>
</body>
</html>